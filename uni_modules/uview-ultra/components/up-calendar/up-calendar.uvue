<template>
	<up-popup
		:show="show"
		mode="bottom"
		closeable
		@close="close"
		:round="round"
		:closeOnClickOverlay="closeOnClickOverlay"
	>
		<view class="up-calendar">
			<uHeader
				:title="title"
				:subtitle="subtitle"
				:showSubtitle="showSubtitle"
				:showTitle="showTitle"
			></uHeader>
			<scroll-view
				:style="{height: addUnit(listHeight)}"
				scroll-y
				@scroll="onScroll"
				:scroll-top="scrollTop"
				:scrollIntoView="scrollIntoView"
			>
				<uMonth
					:color="color"
					:rowHeight="rowHeight"
					:showMark="showMark"
					:months="months"
					:mode="mode"
					:maxCount="maxCount"
					:startText="startText"
					:endText="endText"
					:defaultDate="defaultDate"
					:minDate="innerMinDate"
					:maxDate="innerMaxDate"
					:maxMonth="monthNum"
					:readonly="readonly"
					:maxRange="maxRange"
					:rangePrompt="rangePrompt"
					:showRangePrompt="showRangePrompt"
					:allowSameDay="allowSameDay"
					ref="month"
					@monthSelected="monthSelectedM"
					@updateMonthTop="updateMonthTopM"
				></uMonth>
			</scroll-view>
			<slot name="footer" v-if="showConfirm">
				<view class="up-calendar__confirm">
					<!-- <up-button
						shape="circle"
						:text="
                            buttonDisabled ? confirmDisabledText : confirmText
                        "
						:color="color"
						@click="confirm"
						:disabled="buttonDisabled"
					></up-button> -->
				</view>
			</slot>
		</view>
	</up-popup>
</template>

<script>
import uHeader from './header.uvue'
import uMonth, { monthsItem, monthsItemDate } from './month.uvue'
import { propsCalendar } from './props'
import util from './util'
import {dayuts} from '@/uni_modules/lime-dayuts';
// import Calendar from '../../libs/util/calendar'
import { mpMixin } from '../../libs/mixin/mpMixin'
import { mixin } from '../../libs/mixin/mixin'
import { addUnit, range, error, padZero } from '../../libs/function/index';
import { number as testNumber, array as testArray } from '../../libs/function/test';
/**
 * Calendar 日历
 * @description  此组件用于单个选择日期，范围选择日期等，日历被包裹在底部弹起的容器中.
 * @tutorial https://ijry.github.io/uview-plus/components/calendar.html
 *
 * @property {String}				title				标题内容 (默认 日期选择 )
 * @property {Boolean}				showTitle			是否显示标题  (默认 true )
 * @property {Boolean}				showSubtitle		是否显示副标题	(默认 true )
 * @property {String}				mode				日期类型选择  single-选择单个日期，multiple-可以选择多个日期，range-选择日期范围 （ 默认 'single' )
 * @property {String}				startText			mode=range时，第一个日期底部的提示文字  (默认 '开始' )
 * @property {String}				endText				mode=range时，最后一个日期底部的提示文字 (默认 '结束' )
 * @property {Array}				customList			自定义列表
 * @property {String}				color				主题色，对底部按钮和选中日期有效  (默认 ‘#3c9cff' )
 * @property {String | Number}		minDate				最小的可选日期	 (默认 0 )
 * @property {String | Number}		maxDate				最大可选日期  (默认 0 )
 * @property {Array | String| Date}	defaultDate			默认选中的日期，mode为multiple或range是必须为数组格式
 * @property {String | Number}		maxCount			mode=multiple时，最多可选多少个日期  (默认 	Number.MAX_SAFE_INTEGER  )
 * @property {String | Number}		rowHeight			日期行高 (默认 56 )
 * @property {Function}				formatter			日期格式化函数
 * @property {Boolean}				showLunar			是否显示农历  (默认 false )
 * @property {Boolean}				showMark			是否显示月份背景色 (默认 true )
 * @property {String}				confirmText			确定按钮的文字 (默认 '确定' )
 * @property {String}				confirmDisabledText	确认按钮处于禁用状态时的文字 (默认 '确定' )
 * @property {Boolean}				show				是否显示日历弹窗 (默认 false )
 * @property {Boolean}				closeOnClickOverlay	是否允许点击遮罩关闭日历 (默认 false )
 * @property {Boolean}				readonly	        是否为只读状态，只读状态下禁止选择日期 (默认 false )
 * @property {String | Number}		maxRange	        日期区间最多可选天数，默认无限制，mode = range时有效
 * @property {String}				rangePrompt	        范围选择超过最多可选天数时的提示文案，mode = range时有效
 * @property {Boolean}				showRangePrompt	    范围选择超过最多可选天数时，是否展示提示文案，mode = range时有效 (默认 true )
 * @property {Boolean}				allowSameDay	    是否允许日期范围的起止时间为同一天，mode = range时有效 (默认 false )
 * @property {Number|String}	    round				圆角值，默认无圆角  (默认 0 )
 * @property {Number|String}	    monthNum			最多展示的月份数量  (默认 3 )
 *
 * @event {Function()} confirm 		点击确定按钮时触发		选择日期相关的返回参数
 * @event {Function()} close 		日历关闭时触发			可定义页面关闭时的回调事件
 * @example <up-calendar  :defaultDate="defaultDateMultiple" :show="show" mode="multiple" @confirm="confirm">
	</up-calendar>
 * */
import defProps from './calendar.uts';
let calendarProp = defProps['calendar'] as UTSJSONObject;
export default {
	name: 'up-calendar',
	mixins: [mpMixin, mixin],
	// mixins: [mpMixin, mixin, propsCalendar],
	components: {
		uHeader,
		uMonth
	},
	props: {
	    // 日历顶部标题
	    title: {
	        type: String,
	        default: calendarProp['title']
	    },
	    // 是否显示标题
	    showTitle: {
	        type: Boolean,
	        default: calendarProp['showTitle']
	    },
	    // 是否显示副标题
	    showSubtitle: {
	        type: Boolean,
	        default: calendarProp['showSubtitle']
	    },
	    // 日期类型选择，single-选择单个日期，multiple-可以选择多个日期，range-选择日期范围
	    mode: {
	        type: String,
	        default: calendarProp['mode']
	    },
	    // mode=range时，第一个日期底部的提示文字
	    startText: {
	        type: String,
	        default: calendarProp['startText']
	    },
	    // mode=range时，最后一个日期底部的提示文字
	    endText: {
	        type: String,
	        default: calendarProp['endText']
	    },
	    // 自定义列表
	    customList: {
	        type: Array,
	        default: calendarProp['customList']
	    },
	    // 主题色，对底部按钮和选中日期有效
	    color: {
	        type: String,
	        default: calendarProp['color']
	    },
	    // 最小的可选日期
	    minDate: {
	        type: [String, Number],
	        default: calendarProp['minDate']
	    },
	    // 最大可选日期
	    maxDate: {
	        type: [String, Number],
	        default: calendarProp['maxDate']
	    },
	    // 默认选中的日期，mode为multiple或range是必须为数组格式
		// @ts-ignore
	    defaultDate: {
	        type: [Array, String, Date, null],
	        default: calendarProp['defaultDate']
	    },
	    // mode=multiple时，最多可选多少个日期
	    maxCount: {
	        type: [String, Number],
	        default: calendarProp['maxCount']
	    },
	    // 日期行高
	    rowHeight: {
	        type: [String, Number],
	        default: calendarProp['rowHeight']
	    },
	    // 日期格式化函数
		// @ts-ignore
	    formatter: {
	        type: [Function, null],
	        default: calendarProp['formatter']
	    },
	    // 是否显示农历
	    showLunar: {
	        type: Boolean,
	        default: calendarProp['showLunar']
	    },
	    // 是否显示月份背景色
	    showMark: {
	        type: Boolean,
	        default: calendarProp['showMark']
	    },
	    // 确定按钮的文字
	    confirmText: {
	        type: String,
	        default: calendarProp['confirmText']
	    },
	    // 确认按钮处于禁用状态时的文字
	    confirmDisabledText: {
	        type: String,
	        default: calendarProp['confirmDisabledText']
	    },
	    // 是否显示日历弹窗
	    show: {
	        type: Boolean,
	        default: calendarProp['show']
	    },
	    // 是否允许点击遮罩关闭日历
	    closeOnClickOverlay: {
	        type: Boolean,
	        default: calendarProp['closeOnClickOverlay']
	    },
	    // 是否为只读状态，只读状态下禁止选择日期
	    readonly: {
	        type: Boolean,
	        default: calendarProp['readonly']
	    },
	    // 	是否展示确认按钮
	    showConfirm: {
	        type: Boolean,
	        default: calendarProp['showConfirm']
	    },
	    // 日期区间最多可选天数，默认无限制，mode = range时有效
	    maxRange: {
	        type: [Number, String],
	        default: calendarProp['maxRange']
	    },
	    // 范围选择超过最多可选天数时的提示文案，mode = range时有效
	    rangePrompt: {
	        type: String,
	        default: calendarProp['rangePrompt']
	    },
	    // 范围选择超过最多可选天数时，是否展示提示文案，mode = range时有效
	    showRangePrompt: {
	        type: Boolean,
	        default: calendarProp['showRangePrompt']
	    },
	    // 是否允许日期范围的起止时间为同一天，mode = range时有效
	    allowSameDay: {
	        type: Boolean,
	        default: calendarProp['allowSameDay']
	    },
		// 圆角值
		round: {
		    type: [Boolean, String, Number],
		    default: calendarProp['round']
		},
		// 最多展示月份数量
		monthNum: {
			type: [Number, String],
			default: 3
		}	
	},
	data() {
		return {
			start: 0,
			// 需要显示的月份的数组
			months: [] as monthsItem[],
			// 在月份滚动区域中，当前视图中月份的index索引
			monthIndex: 0,
			// 月份滚动区域的高度
			listHeight: 0,
			// month组件中选择的日期数组
			selected: [] as Array<string>,
			scrollIntoView: '',
			scrollIntoViewScroll: '',
			scrollTop:0,
			// 过滤处理方法
			innerFormatter: (value: monthsItemDate):monthsItemDate => value
		}
	},
	watch: {
		scrollIntoView: {
			immediate: true,
			handler(nval) {
				// console.log('scrollIntoView', nval)
			}
		},
		defaultDate: {
			// @ts-ignore
			immediate: true,
			handler() {
				// @ts-ignore
				this.setMonth()
			}
		},
		// @ts-ignore
		selectedChange: {
			immediate: true,
			handler() {
				// @ts-ignore
				this.setMonth()
			}
		},
		// 打开弹窗时，设置月份数据
		show: {
			immediate: true,
			handler(nval) {
				if (nval) {
					// @ts-ignore
					this.setMonth()
				} else {
					// 关闭时重置scrollIntoView，否则会出现二次打开日历，当前月份数据显示不正确。
					// scrollIntoView需要有一个值变动过程，才会产生作用。
					// @ts-ignore
					this.scrollIntoView = ''
				}
			}
		}
	},
	computed: {
		// 由于maxDate和minDate可以为字符串(2021-10-10)，或者数值(时间戳)，但是dayuts如果接受字符串形式的时间戳会有问题，这里进行处理
		innerMaxDate(): string {
			// @ts-ignore
			return testNumber(this.maxDate)
			// @ts-ignore
				? (this.maxDate as number).toString()
				// @ts-ignore
				: this.maxDate.toString()
		},
		innerMinDate(): string {
			// @ts-ignore
			return testNumber(this.minDate)
			// @ts-ignore
				? (this.minDate as number).toString()
				// @ts-ignore
				: this.minDate.toString()
		},
		// 多个条件的变化，会引起选中日期的变化，这里统一管理监听
		selectedChange(): Array<string> {
			// @ts-ignore
			return [this.innerMinDate, this.innerMaxDate]
		},
		subtitle() {
			// 初始化时，this.months为空数组，所以需要特别判断处理
			// @ts-ignore
			if (this.months.length > 0) {
				// @ts-ignore
				let monthIndex: number = this.monthIndex as number
				// @ts-ignore
				return `${this.months[monthIndex]['year']}年${
					// @ts-ignore
					this.months[monthIndex]['month']
				}月`
			} else {
				return ''
			}
		},
		buttonDisabled() {
			// 如果为range类型，且选择的日期个数不足1个时，让底部的按钮出于disabled状态
			// @ts-ignore
			if (this.mode === 'range') {
				// @ts-ignore
				if (this.selected.length <= 1) {
					return true
				} else {
					return false
				}
			} else {
				return false
			}
		}
	},
	mounted() {
		// @ts-ignore
		this.start = Date.now()
		// @ts-ignore
		this.init()
	},
	emits: ["confirm", "close"],
	methods: {
		addUnit(e: any) {
			return addUnit(e)
		},
		// 在微信小程序中，不支持将函数当做props参数，故只能通过ref形式调用
		setFormatter(e: object)  {
			// @ts-ignore
			this.innerFormatter = e as ((val: monthsItemDate) => monthsItemDate)
		},
		// month组件内部选择日期后，通过事件通知给父组件
		monthSelectedM(e: Array<string>, scene: string) {
			// @ts-ignore
			this.selected = e
			// @ts-ignore
			if (!this.showConfirm) {
				// 在不需要确认按钮的情况下，如果为单选，或者范围多选且已选长度大于2，则直接进行返还
				if (
					// @ts-ignore
					this.mode === 'multiple' ||
					// @ts-ignore
					this.mode === 'single' ||
					// @ts-ignore
					(this.mode === 'range' && this.selected.length >= 2)
				) {
				   if( scene === 'init'){
					 return
				   }
				   if( scene === 'tap') {
					   // @ts-ignore
					 this.$emit('confirm', this.selected)
				   }
				}
			}
		},
		init() {
			// 校验maxDate，不能小于minDate。
			if (
				// @ts-ignore
				this.innerMaxDate != '0' &&
				// @ts-ignore
                this.innerMinDate != '0' &&
				// @ts-ignore
				new Date(this.innerMaxDate).getTime() < new Date(this.innerMinDate).getTime()
			) {
				// @ts-ignore
				console.log(this.innerMaxDate)
				return error('maxDate不能小于minDate时间')
			}
			// 滚动区域的高度
			// @ts-ignore
			this.listHeight = this.rowHeight as number * 5 + 30
			this.setMonth()
		},
		close() {
			// @ts-ignore
			this.$emit('close')
		},
		// 点击确定按钮
		confirm() {
			// @ts-ignore
			if (!this.buttonDisabled) {
				// @ts-ignore
				this.$emit('confirm', this.selected)
			}
		},
		// 获得两个日期之间的月份数
		getMonths(minDate: any, maxDate: any): number {
			const minYear = dayuts(minDate).year()
			const minMonth = dayuts(minDate).month() + 1
			const maxYear = dayuts(maxDate).year()
			const maxMonth = dayuts(maxDate).month() + 1
			return (maxYear - minYear) * 12 + (maxMonth - minMonth) + 1
		},
		// 设置月份数据
		setMonth() {
			// 最小日期的毫秒数
			// @ts-ignore
			const minDate = this.innerMinDate != '' ? this.innerMinDate : dayuts().valueOf()
			// 如果没有指定最大日期，则往后推3个月
			const maxDate =
			// @ts-ignore
				this.innerMaxDate != '' ? this.innerMaxDate :
				dayuts(minDate)
				// @ts-ignore
					.add((this.monthNum as number) - 1, 'month')
					.valueOf()
			// 最大最小月份之间的共有多少个月份，
			const months = range(
				1,
				// @ts-ignore
				this.monthNum as number,
				this.getMonths(minDate, maxDate)
			)
			// 先清空数组
			// @ts-ignore
			this.months = [] as monthsItem[]
			for (let i = 0; i < months; i++) {
				let daysInMonth = dayuts(minDate).add(i, 'month').daysInMonth()
				// 需要注意的是，截止HBuilder 4.22 部分平台尚不支持根据元素个数构造Array的写法
				let cm = new Array<Number>()
				for (let i = 0; i < daysInMonth; i++) {
					cm.push(1)
				}
				let cdate: Array<monthsItemDate> = []
				cm.forEach((item, index) => {
						// 日期，取值1-31
						let day = index + 1
						// 星期，0-6，0为周日
						const week = dayuts(minDate)
							.add(i, 'month')
							.date(day)
							.day()
						const date = dayuts(minDate)
							.add(i, 'month')
							.date(day)
							.format('YYYY-MM-DD')
						let bottomInfo = ''
						// @ts-ignore
						if (this.showLunar) {
							// todo将日期转为农历格式
							// const lunar = Calendar.solar2lunar(
							// 	dayuts(date).year(),
							// 	dayuts(date).month() + 1,
							// 	dayuts(date).date()
							// )
							// bottomInfo = lunar.IDayCn
						}
						let config = {
							day: day.toString(),
							week,
							// 小于最小允许的日期，或者大于最大的日期，则设置为disabled状态
							disabled:
								dayuts(date).isBefore(
									dayuts(minDate).format('YYYY-MM-DD')
								) ||
								dayuts(date).isAfter(
									dayuts(maxDate).format('YYYY-MM-DD')
								),
							// 返回一个日期对象，供外部的formatter获取当前日期的年月日等信息，进行加工处理
							date: new Date(date),
							bottomInfo,
							dot: false,
							month:
								dayuts(minDate).add(i, 'month').month() + 1
						} as monthsItemDate
						// todo
						// const formatter: (val: monthsItemDate) => monthsItemDate =
						// 	this.formatter != null ? this.formatter : this.innerFormatter
						// cdate.push(formatter(config))
						cdate.push(config)
					})
				let md:monthsItem = {
					top: 0,
					date: cdate,
					// 当前所属的月份
					month: (dayuts(minDate).add(i, 'month').month() + 1).toString(),
					// 当前年份
					year: dayuts(minDate).add(i, 'month').year().toString()
				}
				// @ts-ignore
				this.months.push(md)
				console.log('&&&&&&&&&&&&&&&&&&&&&')
				// @ts-ignore
				console.log(this.months)
			}
		},
		// 滚动到默认设置的月份
		scrollIntoDefaultMonth(selected: string) {
			// 查询默认日期在可选列表的下标
			// @ts-ignore
			const _index = this.months.findIndex(({
				  year,
				  month
			  }): boolean => {
				month = padZero(month)
				return `${year}-${month}` === selected
			})
			if (_index !== -1) {
				// #ifndef MP-WEIXIN
				// @ts-ignore
				this.$nextTick(() => {
					// @ts-ignore
					this.scrollIntoView = `month-${_index}`
					// @ts-ignore
					this.scrollIntoViewScroll = this.scrollIntoView
				})
				// #endif
				// #ifdef MP-WEIXIN
				this.scrollTop = this.months[_index].top || 0;
				// #endif
			}
		},
		// scroll-view滚动监听
		onScroll(event: UniScrollEvent) {
			// 不允许小于0的滚动值，如果scroll-view到顶了，继续下拉，会出现负数值
			const scrollTop = Math.max(0, event.detail.scrollTop)
			// 将当前滚动条数值，除以滚动区域的高度，可以得出当前滚动到了哪一个月份的索引
			// @ts-ignore
			for (let i = 0; i < this.months.length; i++) {
				// @ts-ignore
				if (scrollTop >= (this.months[i].top > 0 ? this.months[i].top : this.listHeight)) {
					// @ts-ignore
					this.monthIndex = i
					// @ts-ignore
					this.scrollIntoViewScroll = `month-${i}`
				}
			}
		},
		// 更新月份的top值
		updateMonthTopM(topArr: Array<number>) {
			// 设置对应月份的top值，用于onScroll方法更新月份
			topArr.map((item, index) => {
				// @ts-ignore
				this.months[index]['top'] = item
			})

			// 获取默认日期的下标
			// @ts-ignore
			if (this.defaultDate == null) {
				// 如果没有设置默认日期，则将当天日期设置为默认选中的日期
				const select = dayuts().format("YYYY-MM")
				this.scrollIntoDefaultMonth(select)
				return
			}
			let selected = dayuts().format("YYYY-MM");
			// 单选模式，可以是字符串或数组，Date对象等
			// @ts-ignore
			if (!testArray(this.defaultDate)) {
				// @ts-ignore
				selected = dayuts(this.defaultDate).format("YYYY-MM")
			} else {
				// @ts-ignore
				selected = dayuts((this.defaultDate as Array<any>)[0]).format("YYYY-MM");
			}
			this.scrollIntoDefaultMonth(selected)
		}
	}
}
</script>

<style lang="scss" scoped>
@import '../../libs/css/components.scss';

.up-calendar {
	&__confirm {
		padding: 7px 18px;
	}
}
</style>
